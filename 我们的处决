local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local StatsService = game:GetService("Stats")

local KEY_FILE = "oe_key_config.txt"
local CORRECT_KEY = "ğŸ¤®"

local function saveKey(key)
    if writefile then writefile(KEY_FILE, key) end
end

local function loadKey()
    if isfile and isfile(KEY_FILE) then return readfile(KEY_FILE) end
    return ""
end

local function getPing()
    local ping = 100
    pcall(function()
        ping = StatsService.Network.ServerStatsItem["Data Ping"]:GetValue()
    end)
    return ping
end

local function startMainScript()
    local repo = 'https://raw.githubusercontent.com/mstudio45/LinoriaLib/main/'
    local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()
    local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()
    local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()

    local Window = Library:CreateWindow({
        Title = 'oeè„šæœ¬',
        Center = true,
        AutoShow = true,
        TabPadding = 8,
        MenuFadeTime = 0.2
    })

    Library:Notify("[OE] è„šæœ¬åŠ è½½å®Œæˆ - å¡å¯†å·²æ›´æ–°", 5)

    local States = {
        NormalMelee = false,
        HeavyMelee = false,
        HalberdDash = false,
        MeleeRange = 18,
        Heal = false,
        ShieldBlock = false,
        Gun = {KillAura = false, WallCheck = true},
        ESP = false
    }

    local PlayerCounterGui = Instance.new("ScreenGui", CoreGui)
    PlayerCounterGui.Name = "OE_Counter"
    local CounterFrame = Instance.new("Frame", PlayerCounterGui)
    CounterFrame.Size = UDim2.new(0, 100, 0, 30)
    CounterFrame.Position = UDim2.new(1, -120, 0, 10)
    CounterFrame.BackgroundColor3 = Color3.new(0, 0, 0)
    CounterFrame.BackgroundTransparency = 0.5
    CounterFrame.BorderSizePixel = 0
    Instance.new("UICorner", CounterFrame).CornerRadius = UDim.new(0, 6)
    local CounterLabel = Instance.new("TextLabel", CounterFrame)
    CounterLabel.Size = UDim2.new(1, 0, 1, 0)
    CounterLabel.BackgroundTransparency = 1
    CounterLabel.TextColor3 = Color3.new(1, 1, 1)
    CounterLabel.TextSize = 14
    CounterLabel.Font = Enum.Font.SourceSansBold
    CounterLabel.Text = "å­˜æ´»äººæ•°: --"

    local alivePlayersFolder = Workspace:WaitForChild("AlivePlayers", 5)
    local aliveZombiesFolder = Workspace:WaitForChild("AliveZombies", 5)

    local function createESP(model)
        if not States.ESP or model:FindFirstChild("OE_ESP_Tag") then return end
        local root = model:WaitForChild("HumanoidRootPart", 2)
        local hum = model:FindFirstChildOfClass("Humanoid")
        if not root or not hum then return end
        local bgui = Instance.new("BillboardGui", model)
        bgui.Name = "OE_ESP_Tag"
        bgui.Adornee = root
        bgui.AlwaysOnTop = true
        bgui.Size = UDim2.new(0, 50, 0, 50)
        bgui.StudsOffset = Vector3.new(0, 2, 0)
        local nameLabel = Instance.new("TextLabel", bgui)
        nameLabel.Size = UDim2.new(1, 0, 1, 0)
        nameLabel.BackgroundTransparency = 1
        nameLabel.TextSize = 12
        nameLabel.Font = Enum.Font.SourceSansBold
        local color = Color3.new(1, 0, 0)
        if model.Name == "Prowler" then color = Color3.new(0, 0.6, 1)
        elseif model.Name == "Runner" then color = Color3.new(1, 1, 0) end
        nameLabel.TextColor3 = color
        task.spawn(function()
            while model.Parent == aliveZombiesFolder and States.ESP and hum.Health > 0 do
                local lpChar = Players.LocalPlayer.Character
                if lpChar and lpChar:FindFirstChild("HumanoidRootPart") then
                    local dist = math.floor((lpChar.HumanoidRootPart.Position - root.Position).Magnitude)
                    nameLabel.Text = model.Name .. "\n[" .. dist .. "m]"
                end
                task.wait(0.5)
            end
            if bgui then bgui:Destroy() end
        end)
    end

    task.spawn(function()
        while true do
            if alivePlayersFolder then
                CounterLabel.Text = "å­˜æ´»äººæ•°: " .. #alivePlayersFolder:GetChildren()
            end
            if States.ESP and aliveZombiesFolder then
                for _, z in ipairs(aliveZombiesFolder:GetChildren()) do
                    createESP(z)
                end
            end
            task.wait(1)
        end
    end)

    local function isVisible(targetPart, character)
        if not States.Gun.WallCheck then return true end
        local origin = character.HumanoidRootPart.Position
        local direction = targetPart.Position - origin
        local raycastParams = RaycastParams.new()
        raycastParams.FilterDescendantsInstances = {character, targetPart.Parent}
        raycastParams.FilterType = Enum.RaycastFilterType.Exclude
        return not Workspace:Raycast(origin, direction, raycastParams)
    end

    RunService.Heartbeat:Connect(function()
        if not States.Gun.KillAura then return end
        local lp = Players.LocalPlayer
        local char = lp.Character
        if not (char and char:FindFirstChild("HumanoidRootPart")) then return end
        local root = char.HumanoidRootPart
        local weapon = nil
        for _, v in ipairs(char:GetChildren()) do
            if v:IsA("Tool") and v:FindFirstChild("Firing") then
                weapon = v
                break
            end
        end
        if weapon and aliveZombiesFolder then
            for _, z in ipairs(aliveZombiesFolder:GetChildren()) do
                local zRoot = z:FindFirstChild("HumanoidRootPart")
                local zHum = z:FindFirstChildOfClass("Humanoid")
                if zRoot and zHum and zHum.Health > 0 then
                    local targetPos = zRoot.Position
                    if z.Name == "Prowler" then
                        local torso = z:FindFirstChild("Torso")
                        targetPos = torso and torso.Position or zRoot.Position
                    else
                        local head = z:FindFirstChild("Head")
                        if head then targetPos = head.Position end
                    end
                    if (root.Position - targetPos).Magnitude <= 250 then
                        if isVisible(zRoot, char) then
                            weapon.Firing:FireServer("real", targetPos)
                            break 
                        end
                    end
                end
            end
        end
    end)

    task.spawn(function()
        local lp = Players.LocalPlayer
        while true do
            local char = lp.Character
            if not char then task.wait(0.5) continue end
            local root = char:FindFirstChild("HumanoidRootPart")
            local backpack = lp:FindFirstChild("Backpack")
            if not (root and backpack) then task.wait(0.1) continue end
            local myPos = root.Position
            local ping = getPing()
            if States.Heal then
                local supplies = char:FindFirstChild("Supplies") or backpack:FindFirstChild("Supplies")
                if supplies then
                    if supplies.Parent == char then
                        for _, t in ipairs(backpack:GetChildren()) do
                            if t:IsA("Tool") and (t:FindFirstChild("Swing") or t:FindFirstChild("Melee")) then
                                t.Parent = char
                            end
                        end
                    end
                    if alivePlayersFolder then
                        for _, pChar in ipairs(alivePlayersFolder:GetChildren()) do
                            local pHum = pChar:FindFirstChild("Humanoid")
                            local pRoot = pChar:FindFirstChild("HumanoidRootPart")
                            if pHum and pRoot and pHum.Health > 0 and pHum.Health < pHum.MaxHealth then
                                supplies.Parent = char
                                local healEvent = supplies:FindFirstChild("HealPlayer")
                                if healEvent then
                                    healEvent:FireServer(pRoot.Position, pRoot.Position, 60, pHum, true, lp)
                                end
                                break
                            end
                        end
                    end
                end
            end
            if States.ShieldBlock then
                local currentShield = char:FindFirstChild("Broad Sword") or char:FindFirstChild("Sabre") or char:FindFirstChild("Rapier") or char:FindFirstChild("Club")
                if currentShield then
                    if currentShield.Name == "Club" then
                        currentShield.ShieldTag:FireServer(true)
                    elseif currentShield:FindFirstChild("Blocked") then
                        currentShield.Blocked:FireServer()
                    end
                    if aliveZombiesFolder then
                        local nearestZ, minD = nil, 50
                        for _, z in ipairs(aliveZombiesFolder:GetChildren()) do
                            local zRoot = z:FindFirstChild("HumanoidRootPart")
                            if zRoot then
                                local d = (myPos - zRoot.Position).Magnitude
                                if d < minD then minD = d nearestZ = z end
                            end
                        end
                        if nearestZ then
                            root.CFrame = CFrame.new(myPos, Vector3.new(nearestZ.HumanoidRootPart.Position.X, myPos.Y, nearestZ.HumanoidRootPart.Position.Z))
                        end
                    end
                end
            end
            if (States.NormalMelee or States.HeavyMelee or States.HalberdDash) and aliveZombiesFolder then
                local weapon = char:FindFirstChildOfClass("Tool")
                if weapon and weapon:FindFirstChild("Swing") then
                    local target, minDist = nil, States.MeleeRange
                    for _, z in ipairs(aliveZombiesFolder:GetChildren()) do
                        local zRoot = z:FindFirstChild("HumanoidRootPart")
                        if zRoot then
                            local d = (myPos - zRoot.Position).Magnitude
                            if d < minDist then target = z minDist = d end
                        end
                    end
                    if target then
                        local swingArg = (weapon.Name == "Broad Sword") and (States.HeavyMelee and 3 or 2) or (States.HeavyMelee and 2 or 1)
                        weapon.Swing:FireServer(swingArg)
                        local lookPos = target.HumanoidRootPart.Position
                        if target.Name == "Prowler" then
                            local torso = target:FindFirstChild("Torso")
                            lookPos = torso and torso.Position or target.HumanoidRootPart.Position
                        end
                        root.CFrame = CFrame.new(myPos, Vector3.new(lookPos.X, myPos.Y, lookPos.Z))
                    end
                end
            end
            local waitTime = (ping > 150) and 0.05 or (ping > 60) and 0.02 or 0.01
            task.wait(waitTime)
        end
    end)

    local Tabs = {
        Melee = Window:AddTab('è¿‘æˆ˜æ€æˆ®'),
        Support = Window:AddTab('è¾…åŠ©ä¸æªæ¢°'),
        ['UI Settings'] = Window:AddTab('UI è®¾ç½®'),
    }

    local MeleeBox = Tabs.Melee:AddLeftGroupbox('è¿‘æˆ˜æ§åˆ¶')
    MeleeBox:AddToggle('NMT', {Text = 'æ™®é€šæ€æˆ®', Default = false, Callback = function(V) States.NormalMelee = V end})
    MeleeBox:AddToggle('HMT', {Text = 'é‡å‡»æ€æˆ®', Default = false, Callback = function(V) States.HeavyMelee = V end})
    MeleeBox:AddToggle('HDS', {Text = 'é•¿æŸ„å†²åˆº', Default = false, Callback = function(V) States.HalberdDash = V end})

    local SupportBox = Tabs.Support:AddLeftGroupbox('æ ¸å¿ƒè¾…åŠ©')
    SupportBox:AddToggle('HealP', {Text = 'è‡ªåŠ¨æ²»ç–—(åŒæŒ)', Default = false, Callback = function(V) States.Heal = V end})
    SupportBox:AddToggle('AutoS', {Text = 'é«˜é¢‘è‡ªåŠ¨æ ¼æŒ¡', Default = false, Callback = function(V) States.ShieldBlock = V end})
    SupportBox:AddToggle('ZESP', {Text = 'åƒµå°¸é€è§†', Default = false, Callback = function(V) States.ESP = V end})

    local GunBox = Tabs.Support:AddRightGroupbox('æªæ¢°æ€æˆ®')
    GunBox:AddToggle('GKA', {Text = 'å¼€å¯æªæ¢°æ€æˆ®', Default = false, Callback = function(V) States.Gun.KillAura = V end})
    GunBox:AddToggle('GWC', {Text = 'å¢™ä½“æ£€æµ‹', Default = true, Callback = function(V) States.Gun.WallCheck = V end})

    ThemeManager:SetLibrary(Library)
    SaveManager:SetLibrary(Library)
    SaveManager:BuildConfigSection(Tabs['UI Settings'])
    ThemeManager:ApplyToTab(Tabs['UI Settings'])
end

local function createLoginGui()
    local screenGui = Instance.new("ScreenGui", CoreGui)
    screenGui.Name = "OE_Login_System"
    local mainFrame = Instance.new("Frame", screenGui)
    mainFrame.Size = UDim2.new(0, 300, 0, 160)
    mainFrame.Position = UDim2.new(0.5, -150, 0.5, -80)
    mainFrame.BackgroundColor3 = Color3.fromRGB(25, 25, 25)
    Instance.new("UICorner", mainFrame).CornerRadius = UDim.new(0, 10)
    local textBox = Instance.new("TextBox", mainFrame)
    textBox.Size = UDim2.new(0, 240, 0, 35)
    textBox.Position = UDim2.new(0.5, -120, 0.45, -5)
    textBox.BackgroundColor3 = Color3.fromRGB(40, 40, 40)
    textBox.TextColor3 = Color3.new(1, 1, 1)
    textBox.Text = loadKey()
    textBox.PlaceholderText = "è¾“å…¥å¡å¯†..."
    local loginBtn = Instance.new("TextButton", mainFrame)
    loginBtn.Size = UDim2.new(0, 240, 0, 35)
    loginBtn.Position = UDim2.new(0.5, -120, 0.75, -5)
    loginBtn.BackgroundColor3 = Color3.fromRGB(50, 120, 255)
    loginBtn.TextColor3 = Color3.new(1, 1, 1)
    loginBtn.Text = "éªŒè¯"
    loginBtn.MouseButton1Click:Connect(function()
        if textBox.Text == CORRECT_KEY then
            saveKey(textBox.Text)
            screenGui:Destroy()
            startMainScript()
        else
            loginBtn.Text = "å¡å¯†é”™è¯¯ï¼"
            task.wait(1)
            loginBtn.Text = "éªŒè¯"
        end
    end)
    if textBox.Text == CORRECT_KEY then task.spawn(function() task.wait(0.2) screenGui:Destroy() startMainScript() end) end
end

createLoginGui()

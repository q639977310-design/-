local Players = game:GetService("Players")
local CoreGui = game:GetService("CoreGui")
local RunService = game:GetService("RunService")
local Workspace = game:GetService("Workspace")
local StatsService = game:GetService("Stats")

local KEY_FILE = "oe_key_config.txt"
local CORRECT_KEY = "我是gay"

local function saveKey(key) if writefile then pcall(writefile, KEY_FILE, key) end end
local function loadKey() if isfile and isfile(KEY_FILE) then return readfile(KEY_FILE) end return "" end

local function getPing()
    local ping = 100
    pcall(function() ping = StatsService.Network.ServerStatsItem["Data Ping"]:GetValue() end)
    return ping
end

local function startMainScript()
    local repo = 'https://raw.githubusercontent.com/mstudio45/LinoriaLib/main/'
    local Library = loadstring(game:HttpGet(repo .. 'Library.lua'))()
    local ThemeManager = loadstring(game:HttpGet(repo .. 'addons/ThemeManager.lua'))()
    local SaveManager = loadstring(game:HttpGet(repo .. 'addons/SaveManager.lua'))()

    local Window = Library:CreateWindow({ Title = 'oe脚本', Center = true, AutoShow = true })

    local States = {
        NormalMelee = false, HeavyMelee = false, HalberdDash = false, MeleeRange = 18,
        Heal = false, ShieldBlock = false,
        GunKillAura = false,
        GunBotAura = false,
        GunWallCheck = true,
        ESP = false
    }

    local aliveZombiesFolder = Workspace:WaitForChild("AliveZombies", 5)
    local alivePlayersFolder = Workspace:WaitForChild("AlivePlayers", 5)

    local function isStrictGunBot(model)
        if not model then return false end
        return model:FindFirstChild("OfficerPistol") or model:FindFirstChild("Rifle")
    end

    local function getTargetColor(model)
        if isStrictGunBot(model) then return Color3.new(0, 0, 0) end
        local name = model.Name
        if name == "Prowler" then return Color3.new(0, 0.5, 1)
        elseif name == "Runner" then return Color3.new(1, 1, 0)
        elseif name == "ZombieEngineer" then return Color3.new(0, 1, 0) end
        return Color3.new(1, 0, 0)
    end

    local function isVisible(targetPart)
        local char = Players.LocalPlayer.Character
        if not (char and char:FindFirstChild("HumanoidRootPart")) then return false end
        local origin = char.HumanoidRootPart.Position
        local direction = (targetPart.Position - origin).Unit * (targetPart.Position - origin).Magnitude
        local ray = Ray.new(origin, direction)
        local hit = Workspace:FindPartOnRayWithIgnoreList(ray, {char, targetPart.Parent, Workspace.CurrentCamera})
        return hit == nil
    end

    RunService.Heartbeat:Connect(function()
        local lp = Players.LocalPlayer
        local char = lp.Character
        if not (char and char:FindFirstChild("HumanoidRootPart")) then return end
        if not (States.GunKillAura or States.GunBotAura) then return end
        
        local tool = char:FindFirstChildOfClass("Tool")
        if not tool then return end
        local fireRemote = tool:FindFirstChild("Firing") or tool:FindFirstChild("Fire")
        if not fireRemote then return end

        local rootPos = char.HumanoidRootPart.Position
        local ping = getPing()

        for _, z in ipairs(aliveZombiesFolder:GetChildren()) do
            local zRoot = z:FindFirstChild("HumanoidRootPart")
            local zHum = z:FindFirstChildOfClass("Humanoid")
            if zRoot and zHum and zHum.Health > 0 then
                local dist = (rootPos - zRoot.Position).Magnitude
                if dist <= 350 then
                    if States.GunWallCheck and not isVisible(zRoot) then continue end
                    local shouldShoot = false
                    if States.GunKillAura then shouldShoot = true
                    elseif States.GunBotAura and isStrictGunBot(z) then shouldShoot = true end
                    if shouldShoot then
                        local travelTime = (dist / 850) + (ping / 1000)
                        local predictedPos = zRoot.Position + (zRoot.Velocity * travelTime)
                        fireRemote:FireServer("real", predictedPos)
                    end
                end
            end
        end
    end)

    task.spawn(function()
        while true do
            if States.ShieldBlock then
                local char = Players.LocalPlayer.Character
                if char then
                    local shield = char:FindFirstChild("Sabre") or char:FindFirstChild("Broad Sword") or char:FindFirstChild("Club")
                    if shield then
                        if shield.Name == "Club" then
                            shield.ShieldTag:FireServer(true)
                            task.wait(0.2) 
                        elseif shield:FindFirstChild("Blocked") then
                            shield.Blocked:FireServer()
                            task.wait(0.1)
                        end
                    end
                end
            end
            task.wait(0.05)
        end
    end)

    task.spawn(function()
        local lp = Players.LocalPlayer
        while true do
            local char = lp.Character
            if char and char:FindFirstChild("HumanoidRootPart") then
                local root = char.HumanoidRootPart

                if States.Heal then
                    local supplies = lp.Backpack:FindFirstChild("Supplies") or char:FindFirstChild("Supplies")
                    if supplies then
                        for _, p in ipairs(alivePlayersFolder:GetChildren()) do
                            local hum = p:FindFirstChild("Humanoid")
                            if hum and hum.Health < hum.MaxHealth then
                                supplies.Parent = char
                                supplies.HealPlayer:FireServer(p.HumanoidRootPart.Position, p.HumanoidRootPart.Position, 60, hum, true, lp)
                                
                                local melee = lp.Backpack:FindFirstChild("Sabre") or lp.Backpack:FindFirstChild("Broad Sword") or lp.Backpack:FindFirstChild("Club") or lp.Backpack:FindFirstChild("Halberd")
                                if melee then melee.Parent = char end
                                break
                            end
                        end
                    end
                end

                if (States.NormalMelee or States.HeavyMelee or States.HalberdDash) then
                    local tool = char:FindFirstChildOfClass("Tool")
                    if tool and tool:FindFirstChild("Swing") then
                        for _, z in ipairs(aliveZombiesFolder:GetChildren()) do
                            local zRoot = z:FindFirstChild("HumanoidRootPart")
                            if zRoot and (root.Position - zRoot.Position).Magnitude < States.MeleeRange then
                                root.CFrame = CFrame.new(root.Position, Vector3.new(zRoot.Position.X, root.Position.Y, zRoot.Position.Z))
                                local arg = States.HalberdDash and 3 or (States.HeavyMelee and 2 or 1)
                                tool.Swing:FireServer(arg)
                                break
                            end
                        end
                    end
                end
            end
            task.wait(0.02)
        end
    end)

    local function createESP(model)
        if not States.ESP or model:FindFirstChild("OE_Heart_ESP") then return end
        local root = model:WaitForChild("HumanoidRootPart", 1)
        if not root then return end
        local bgui = Instance.new("BillboardGui", model)
        bgui.Name = "OE_Heart_ESP"; bgui.Adornee = root; bgui.AlwaysOnTop = true; bgui.Size = UDim2.new(0, 80, 0, 80)
        local dot = Instance.new("Frame", bgui); dot.Size = UDim2.new(0, 8, 0, 8); dot.Position = UDim2.new(0.5, -4, 0.4, -4); dot.BorderSizePixel = 0
        Instance.new("UICorner", dot).CornerRadius = UDim.new(1, 0)
        local nameLabel = Instance.new("TextLabel", bgui); nameLabel.Size = UDim2.new(1, 100, 0, 20); nameLabel.Position = UDim2.new(0.5, -50, 0.4, 6); nameLabel.BackgroundTransparency = 1; nameLabel.TextColor3 = Color3.new(1,1,1); nameLabel.TextSize = 12; nameLabel.Font = Enum.Font.SourceSansBold
        task.spawn(function()
            while model.Parent == aliveZombiesFolder and States.ESP do
                local lpChar = Players.LocalPlayer.Character
                if lpChar and lpChar:FindFirstChild("HumanoidRootPart") then
                    local dist = math.floor((lpChar.HumanoidRootPart.Position - root.Position).Magnitude)
                    nameLabel.Text = model.Name .. " [" .. dist .. "m]"
                    dot.BackgroundColor3 = getTargetColor(model)
                    bgui.Enabled = true
                end
                task.wait(0.3)
            end
            bgui:Destroy()
        end)
    end

    local Tabs = { Melee = Window:AddTab('近战'), Gun = Window:AddTab('枪械'), Misc = Window:AddTab('综合') }
    local MBox = Tabs.Melee:AddLeftGroupbox('杀戮')
    MBox:AddToggle('NM', {Text = '普攻', Default = false, Callback = function(v) States.NormalMelee = v end})
    MBox:AddToggle('HM', {Text = '重击', Default = false, Callback = function(v) States.HeavyMelee = v end})
    MBox:AddToggle('HD', {Text = '哈尔珀特冲刺', Default = false, Callback = function(v) States.HalberdDash = v end})

    local GBox = Tabs.Gun:AddLeftGroupbox('枪械范围')
    GBox:AddToggle('GKA', {Text = '枪械全目标杀戮', Default = false, Callback = function(v) States.GunKillAura = v end})
    GBox:AddToggle('GBA', {Text = '枪械Bot筛选杀戮', Default = false, Callback = function(v) States.GunBotAura = v end})
    GBox:AddToggle('GWC', {Text = '枪械墙壁检测', Default = true, Callback = function(v) States.GunWallCheck = v end})

    local ABox = Tabs.Misc:AddLeftGroupbox('辅助')
    ABox:AddToggle('ESP', {Text = '透视', Default = false, Callback = function(v) 
        States.ESP = v 
        if v then task.spawn(function() while States.ESP do for _, z in ipairs(aliveZombiesFolder:GetChildren()) do createESP(z) end task.wait(1) end end) end
    end})
    ABox:AddToggle('Block', {Text = '格挡', Default = false, Callback = function(v) States.ShieldBlock = v end})
    ABox:AddToggle('Heal', {Text = '医疗', Default = false, Callback = function(v) States.Heal = v end})

    SaveManager:SetLibrary(Library); ThemeManager:ApplyToTab(Tabs['Misc'])
end

local function createLoginGui()
    local screenGui = Instance.new("ScreenGui", CoreGui) screenGui.Name = "OE_Login"
    local mainFrame = Instance.new("Frame", screenGui) mainFrame.Size = UDim2.new(0, 300, 0, 160) mainFrame.Position = UDim2.new(0.5, -150, 0.5, -80) mainFrame.BackgroundColor3 = Color3.fromRGB(30,30,30) Instance.new("UICorner", mainFrame)
    local textBox = Instance.new("TextBox", mainFrame) textBox.Size = UDim2.new(0, 240, 0, 35) textBox.Position = UDim2.new(0.5, -120, 0.4, 0) textBox.Text = loadKey(); textBox.PlaceholderText = "输入卡密"
    local loginBtn = Instance.new("TextButton", mainFrame) loginBtn.Size = UDim2.new(0, 240, 0, 35) loginBtn.Position = UDim2.new(0.5, -120, 0.7, 0); loginBtn.Text = "验证登录"
    loginBtn.MouseButton1Click:Connect(function() if textBox.Text == CORRECT_KEY then saveKey(textBox.Text); screenGui:Destroy(); startMainScript() end end)
    if textBox.Text == CORRECT_KEY then task.wait(0.1); screenGui:Destroy(); startMainScript() end
end
createLoginGui()
